<!-- Countdown clock - CSS -->

<style>
  .tsw-countdown-container {
    --tsw-font-display: "TeleNeo Web", var(--phx--text-family-brand), -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    --tsw-font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif,
      "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";

    --tsw-font-size: 16px;
    --color-brand-primary-400: #e20074;
    --color-brand-primary-600: #770141;
    --color-brand-grayscale-400: #8c8c8c;
    --color-brand-grayscale-900: #1c1c1c;
    --color-brand-grayscale-white: #fff;

    font-family: var(--tsw-font-main);
  }

  .tsw-countdown {
    --countdown-text-color: var(--color-brand-grayscale-900);
    --countdown-background-color: var(--color-brand-grayscale-white);
    --time-unit-text-color: var(--color-brand-grayscale-white);
    --time-unit-background-color: var(--color-brand-grayscale-900);

    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    padding: 2rem;
    color: var(--countdown-text-color);
    background-color: var(--countdown-background-color);
  }

  .tsw-countdown.dark-theme {
    --countdown-text-color: var(--color-brand-grayscale-white);
    --countdown-background-color: var(--color-brand-grayscale-900);
    --time-unit-text-color: var(--color-brand-grayscale-900);
    --time-unit-background-color: var(--color-brand-grayscale-white);
  }

  /* UI Elements */

  .tsw-countdown button {
    cursor: pointer;
    padding: 10px 15px;
    font-size: 14px;
    font-weight: 700;
    border: 0;
    color: var(--color-brand-grayscale-white);
    background-color: var(--color-brand-primary-400);
  }

  /* Modal and overlay */

  .tsw-modal {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50vw;
    max-width: 500px;
    padding: 4rem;
    font-size: 16px;
    font-weight: 700;
    background-color: var(--color-brand-grayscale-white);
    z-index: 1001;
  }
  .tsw-modal {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .tsw-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(7px);
    -webkit-backdrop-filter: blur(7px);
    z-index: 1000;
    display: none;
  }
  .tsw-modal-overlay.is-visible {
    display: block;
  }

  /* Clock */

  .tsw-countdown-clock {
    display: grid;
    grid-template-columns: 1fr auto 1fr auto 1fr auto 1fr;
    align-items: center;
    gap: 1rem;
  }

  .tsw-countdown-clock .tsw-time-unit {
    flex: 1;
    text-align: center;
    padding: 1rem;
    color: var(--time-unit-text-color);
    background-color: var(--time-unit-background-color);
    border-radius: 0.5rem;
  }

  .tsw-countdown-clock .tsw-time-unit .tsw-number {
    display: block;
    font-size: 3rem;
    line-height: 4rem;
    font-weight: 700;
    color: var(--color-brand-primary-400);
  }

  .tsw-countdown-clock .tsw-time-colon {
    font-size: 3rem;
    font-weight: 800;
  }

  /* Status */

  .tsw-countdown-status {
    display: none;
    text-align: center;
  }
  .tsw-countdown-status .tsw-countdown-status-alert {
    margin: 0;
    color: var(--color-brand-primary-400);
  }
</style>

<!-- Countdown clock - HTML -->

<div class="tsw-countdown-container">
  <div class="tsw-modal-overlay">
    <div class="tsw-modal">
      <div>
        <label for="tsw-countdown-date">Target date/time:</label>
        <input type="datetime-local" class="tsw-countdown-date" name="tsw-countdown-date" />
      </div>
      <div class="tsw-dropdown">
        <select id="tsw-dropdown-theme" name="tsw-dropdown-theme" aria-controls="">
          <option value=""></option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
        <label aria-hidden="true" id="tsw-dropdown-theme-label" for="tsw-dropdown-theme">Theme</label>
        <span aria-hidden="true" class="tsw-dropdown-caret"></span>
      </div>
      <div class="tsw-dropdown">
        <select id="tsw-dropdown-time-zone" name="tsw-dropdown-time-zone" aria-controls="">
          <option value=""></option>
          <option value="local">Local</option>
          <option value="eastern">Eastern (EST)</option>
        </select>
        <label aria-hidden="true" id="tsw-dropdown-time-zone-label" for="tsw-dropdown-time-zone"
          >Time zone for target time</label
        >
        <span aria-hidden="true" class="tsw-dropdown-caret"></span>
      </div>
    </div>
  </div>

  <div class="tsw-countdown">
    <div class="tsw-countdown-interface">
      <button class="tsw-countdown-edit">Edit countdown clock</button>
    </div>

    <div class="tsw-countdown-clock">
      <div class="tsw-time-unit">
        <span class="tsw-countdown-days tsw-number">--</span>
        <span>Days</span>
      </div>
      <span class="tsw-time-colon">:</span>
      <div class="tsw-time-unit">
        <span class="tsw-countdown-hours tsw-number">--</span>
        <span>Hours</span>
      </div>
      <span class="tsw-time-colon">:</span>
      <div class="tsw-time-unit">
        <span class="tsw-countdown-minutes tsw-number">--</span>
        <span>Minutes</span>
      </div>
      <span class="tsw-time-colon">:</span>
      <div class="tsw-time-unit">
        <span class="tsw-countdown-seconds tsw-number">--</span>
        <span>Seconds</span>
      </div>
    </div>

    <div class="tsw-countdown-status">
      <p class="tsw-countdown-status-alert"></p>
    </div>

    <div
      id="tsw-countdown-a11y-alert"
      role="alert"
      aria-live="assertive"
      style="position: absolute; width: 0; height: 0; clip: rect(0, 0, 0, 0)"
    ></div>
  </div>
</div>

<!-- Countdown clock - JavaScript -->

<script>
  const CountDownClock = {
    countDownToThisTime: null,
    countDown: null,
    timeZoneForTarget: "local",
    theme: "light",
    urgencyInterval: 1,
    a11yAlertInterval: 10,
    init(selectedDateArg, timeZoneArg, themeArg, urgencyIntervalArg, a11yAlertIntervalArg) {
      this.countDownWrapper = document.querySelector("#tsw-countdown-id").querySelector("xpr-npi-content");
      this.countDownEl = this.countDownWrapper.shadowRoot.querySelector(".tsw-countdown");
      if (!this.countDownEl) return;
      if (a11yAlertIntervalArg !== undefined) {
        if (!Number.isInteger(a11yAlertIntervalArg)) {
          throw new Error("Argument is not a number");
        }
        this.a11yAlertInterval = a11yAlertIntervalArg;
      }
      this.timeZoneForTarget = timeZoneArg;
      this.theme = themeArg;
      this.urgencyInterval = urgencyIntervalArg;
      this.selectedDate = selectedDateArg;
      this.countDownToThisTime = this.setTimeZoneForTarget(selectedDateArg);
      this.setTheme(this.theme);
      this.countDown = this.startCountDown();
    },
    setTimeZoneForTarget(date) {
      if (this.timeZoneForTarget === "eastern") {
        // Set time zone of input date/time using Luxon DateTime object
        const overrideZone = luxon.DateTime.fromISO(date, { zone: "America/New_York" });
        // Convert back to local time and to a Date object using Luxon's toJSDate() method
        return overrideZone.toJSDate();
      } else {
        return new Date(date);
      }
    },
    setTheme(theme) {
      theme === "dark" ? this.countDownEl.classList.add("dark-theme") : this.countDownEl.classList.remove("dark-theme");
    },
    startCountDown() {
      return setInterval(() => {
        const secondsLeft = (this.countDownToThisTime - Date.now()) / 1000;
        if (secondsLeft < 0) {
          this.stopClock();
        }
        this.setView(secondsLeft);
      }, 1000);
    },
    setView(seconds) {
      console.log("triggered");
      const displayDays = this.countDownEl.querySelector(".tsw-countdown-days");
      const displayHours = this.countDownEl.querySelector(".tsw-countdown-hours");
      const displayMinutes = this.countDownEl.querySelector(".tsw-countdown-minutes");
      const displaySeconds = this.countDownEl.querySelector(".tsw-countdown-seconds");
      const statusWrapper = this.countDownEl.querySelector(".tsw-countdown-status");
      const statusAlert = this.countDownEl.querySelector(".tsw-countdown-status-alert");
      const a11yAlert = this.countDownEl.querySelector("#tsw-countdown-a11y-alert");
      const secs = Math.floor(seconds % 60);
      const mins = Math.floor((seconds / 60) % 60);
      const hrs = Math.floor((seconds / (60 * 60)) % 24);
      const dys = Math.floor(seconds / (60 * 60 * 24));
      displaySeconds.textContent = secs > 0 ? (secs < 10 ? "0" + secs : secs) : "00";
      displayMinutes.textContent = mins > 0 ? (mins < 10 ? "0" + mins : mins) : "00";
      displayHours.textContent = hrs > 0 ? (hrs < 10 ? "0" + hrs : hrs) : "00";
      displayDays.textContent = dys > 0 ? (dys < 10 ? "0" + dys : dys) : "00";
      if (dys < this.a11yAlertInterval) {
        a11yAlert.textContent = "Less than 24 hours to go!!!";
      } else {
        a11yAlert.textContent = "";
      }
      if (dys < this.urgencyInterval) {
        statusWrapper.style.display = "block";
        statusAlert.textContent = "Less than 24 hours to go!!!";
      } else {
        statusWrapper.style.display = "none";
        statusAlert.textContent = "";
      }
    },
    stopClock() {
      clearInterval(this.countDown);
      this.countDownToThisTime = null;
    },
  };

  const countdownWrapper = document.querySelector("#tsw-countdown-id").querySelector("xpr-npi-content").shadowRoot;
  const dateTimeInput = countdownWrapper.querySelector(".tsw-countdown-date");

  window.addEventListener("load", () => {
    // Generate default ISO string for 24 hours from now with Luxon DateTime object
    const today = luxon.DateTime.local();
    const tomorrow = today.plus({ days: 1 });
    const formattedResult = tomorrow.toFormat("yyyy-MM-dd'T'HH:mm");
    dateTimeInput.value = formattedResult;
    CountDownClock.init(formattedResult, "local", "light", 1, 30);
  });

  // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
  // Modal and overlay event listeners
  // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

  const countdownEditButton = countdownWrapper.querySelector(".tsw-countdown-edit");
  const modalOverlay = countdownWrapper.querySelector(".tsw-modal-overlay");
  const dropdownTheme = countdownWrapper.querySelector("#tsw-dropdown-theme");
  const dropdownTimeZone = countdownWrapper.querySelector("#tsw-dropdown-time-zone");

  // Open modal
  countdownEditButton.addEventListener("click", () => {
    // Pre-populate modal fields and dropdowns with current clock state
    dateTimeInput.value = CountDownClock.selectedDate;
    dropdownTheme.value = CountDownClock.theme;
    dropdownTimeZone.value = CountDownClock.timeZoneForTarget;
    // Open modal
    modalOverlay.classList.add("is-visible");
  });

  // Close modal
  modalOverlay.addEventListener("click", (event) => {
    if (event.target === modalOverlay) {
      modalOverlay.classList.remove("is-visible");
    }
  });

  // Change theme
  dropdownTheme.addEventListener("change", (event) => {
    CountDownClock.setTheme(event.target.value);
  });

  // Change time zone
  dropdownTimeZone.addEventListener("change", (event) => {
    CountDownClock.timeZoneForTarget = event.target.value;
    clearInterval(CountDownClock.countDown);
    CountDownClock.countDownToThisTime = CountDownClock.setTimeZoneForTarget(CountDownClock.selectedDate);
    CountDownClock.startCountDown();
  });

  // Change target date
  dateTimeInput.addEventListener("change", (event) => {
    const newDateTime = event.target.value;

    if (!newDateTime) return;

    const selectedTime = CountDownClock.setTimeZoneForTarget(newDateTime);
    if (selectedTime < Date.now()) {
      alert("Please select a future date and time");
      dateTimeInput.value = CountDownClock.selectedDate;
      return;
    }

    clearInterval(CountDownClock.countDown);
    CountDownClock.selectedDate = newDateTime;
    CountDownClock.countDownToThisTime = selectedTime;

    CountDownClock.countDown = CountDownClock.startCountDown();
  });
</script>
