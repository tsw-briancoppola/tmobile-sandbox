<!-- Countdown clock - CSS -->

<style>
  .tsw-countdown-container {
    --tsw-font-display: "TeleNeo Web", var(--phx--text-family-brand), -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    --tsw-font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif,
      "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";

    --tsw-font-size: 16px;
    --color-brand-primary-400: #e20074;
    --color-brand-primary-600: #770141;
    --color-brand-grayscale-400: #ccc;
    --color-brand-grayscale-500: #8c8c8c;
    --color-brand-grayscale-600: #6a6a6a;
    --color-brand-grayscale-700: #414141;
    --color-brand-grayscale-900: #1c1c1c;
    --color-brand-grayscale-white: #fff;

    --color-overlay: rgba(0, 0, 0, 0.4);
    --color-input-shadow: 0px 0px 5px 0px rgba(226, 0, 116, 0.5);

    font-family: var(--tsw-font-main);
  }

  .tsw-countdown {
    --countdown-text-color: var(--color-brand-grayscale-900);
    --countdown-background-color: var(--color-brand-grayscale-white);
    --time-unit-text-color: var(--color-brand-grayscale-white);
    --time-unit-background-color: var(--color-brand-grayscale-900);

    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    padding: 2rem;
    color: var(--countdown-text-color);
    background-color: var(--countdown-background-color);
  }

  .tsw-countdown.dark-theme {
    --countdown-text-color: var(--color-brand-grayscale-white);
    --countdown-background-color: var(--color-brand-grayscale-900);
    --time-unit-text-color: var(--color-brand-grayscale-900);
    --time-unit-background-color: var(--color-brand-grayscale-white);
  }

  /* UI Elements */

  .tsw-countdown button {
    cursor: pointer;
    padding: 10px 15px;
    font-size: 14px;
    font-weight: 700;
    border: 0;
    color: var(--color-brand-grayscale-white);
    background-color: var(--color-brand-primary-400);
  }

  /* Modal and overlay */

  .tsw-modal {
    position: absolute;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50vw;
    max-width: 500px;
    padding: 4rem;
    font-size: 16px;
    font-weight: 700;
    border: 0;
    background-color: var(--color-brand-grayscale-white);
    z-index: 1001;
  }

  .tsw-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--color-overlay);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(7px);
    -webkit-backdrop-filter: blur(7px);
    z-index: 1000;
    display: none;
  }
  .tsw-modal-overlay.is-visible {
    display: block;
  }

  .tsw-modal-close {
    position: absolute;
    width: 50px;
    height: 50px;
    display: flex;
    justify-content: center;
    align-items: center;
    border: none;
    background: var(--color-brand-primary-400);
    color: var(--color-brand-grayscale-white);
    z-index: 1001;
    top: -20px;
    right: -20px;
    font-weight: 900;
    font-size: 27px;
    border: 5px solid var(--color-brand-grayscale-white);
    border-radius: 50%;
    transition: 0.25s;
    cursor: pointer;
  }
  .tsw-modal-close svg {
    height: 100%;
    width: 100%;
    fill: var(--color-brand-grayscale-white);
  }

  .tsw-dropdown {
    width: 100%;
    margin: 10px 0;
    position: relative;
    outline: none;
    transition: 0.25s;
  }

  .tsw-modal label {
    display: block;
    margin-bottom: 0.5rem;
  }

  .tsw-modal input,
  .tsw-modal select {
    width: 100%;
    height: 100%;
    padding: 15px;
    border: 1px solid var(--color-brand-grayscale-500);
    border-radius: 0px;
    font-size: 16px;
    appearance: none;
    box-sizing: border-box;
    position: relative;
  }
  .tsw-modal button:hover,
  .tsw-modal button:focus,
  .tsw-modal input:hover,
  .tsw-modal input:focus,
  .tsw-modal select:hover,
  .tsw-modal select:focus {
    outline: none;
    border: 1px solid var(--color-brand-primary-400);
    box-shadow: var(--color-input-shadow);
  }

  .tsw-dropdown-caret {
    position: absolute;
    transform: rotate(180deg) scale(0.5) translateY(50%);
    top: 50%;
    right: 0.8rem;
    filter: grayscale(100%) brightness(0%);
    transition: 0.25s;
    font-size: 50px;
  }

  .tsw-modal button,
  .tsw-modal input,
  .tsw-modal select,
  .tsw-dropdown-caret {
    transition: 0.25s;
  }

  /* Clock */

  .tsw-countdown-clock {
    display: grid;
    grid-template-columns: 1fr auto 1fr auto 1fr auto 1fr;
    align-items: center;
    gap: 1rem;
  }

  .tsw-countdown-clock .tsw-time-unit {
    flex: 1;
    text-align: center;
    padding: 1rem;
    color: var(--time-unit-text-color);
    background-color: var(--time-unit-background-color);
    border-radius: 0.5rem;
  }

  .tsw-countdown-clock .tsw-time-unit .tsw-number {
    display: block;
    font-size: 3rem;
    line-height: 4rem;
    font-weight: 700;
    color: var(--color-brand-primary-400);
  }

  .tsw-countdown-clock .tsw-time-colon {
    font-size: 3rem;
    font-weight: 800;
  }

  /* Status */

  .tsw-countdown-status {
    display: none;
    text-align: center;
  }
  .tsw-countdown-status .tsw-countdown-status-alert {
    margin: 0;
    color: var(--color-brand-primary-400);
  }
</style>

<!-- Countdown clock - HTML -->

<div id="container--1" class="tsw-countdown-container">
  <!-- Countdown modal -->
  <div class="tsw-modal-overlay">
    <div class="tsw-modal">
      <button class="tsw-modal-close">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
          <path d="M382-208 122-468l90-90 170 170 366-366 90 90-456 456Z" />
        </svg>
      </button>
      <div>
        <label for="tsw-countdown-date">Target date/time</label>
        <input type="datetime-local" class="tsw-countdown-date" name="tsw-countdown-date" />
      </div>

      <div class="tsw-dropdown">
        <label aria-hidden="true" id="tsw-dropdown-time-zone-label" for="tsw-dropdown-time-zone">Placement</label>
        <select
          class="tsw-dropdown-placement"
          id="tsw-dropdown-placement"
          name="tsw-dropdown-placement"
          aria-controls=""
        >
          <option value="card">Card</option>
          <option value="banner">Banner</option>
        </select>
        <span aria-hidden="true" class="tsw-dropdown-caret">
          <i class="fa fa-caret-up"></i>
        </span>
      </div>

      <div class="tsw-dropdown">
        <label aria-hidden="true" id="tsw-dropdown-time-zone-label" for="tsw-dropdown-time-zone"
          >Time zone for target time</label
        >
        <select
          class="tsw-dropdown-time-zone"
          id="tsw-dropdown-time-zone"
          name="tsw-dropdown-time-zone"
          aria-controls=""
        >
          <option value="local">Local</option>
          <option value="eastern">Eastern (EST)</option>
        </select>
        <span aria-hidden="true" class="tsw-dropdown-caret">
          <i class="fa fa-caret-up"></i>
        </span>
      </div>

      <div class="tsw-dropdown">
        <label aria-hidden="true" id="tsw-dropdown-theme-label" for="tsw-dropdown-theme">Theme</label>
        <select class="tsw-dropdown-theme" id="tsw-dropdown-theme" name="tsw-dropdown-theme" aria-controls="">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
        <span aria-hidden="true" class="tsw-dropdown-caret">
          <i class="fa fa-caret-up"></i>
        </span>
      </div>
    </div>
  </div>

  <!-- Countdown clock -->
  <div class="tsw-countdown">
    <div class="tsw-countdown-interface">
      <button class="tsw-countdown-edit">Edit countdown clock</button>
    </div>

    <div class="tsw-countdown-clock">
      <div class="tsw-time-unit">
        <span class="tsw-countdown-days tsw-number">--</span>
        <span>Days</span>
      </div>
      <span class="tsw-time-colon">:</span>
      <div class="tsw-time-unit">
        <span class="tsw-countdown-hours tsw-number">--</span>
        <span>Hours</span>
      </div>
      <span class="tsw-time-colon">:</span>
      <div class="tsw-time-unit">
        <span class="tsw-countdown-minutes tsw-number">--</span>
        <span>Minutes</span>
      </div>
      <span class="tsw-time-colon">:</span>
      <div class="tsw-time-unit">
        <span class="tsw-countdown-seconds tsw-number">--</span>
        <span>Seconds</span>
      </div>
    </div>

    <div class="tsw-countdown-status">
      <p class="tsw-countdown-status-alert"></p>
    </div>

    <div
      id="tsw-countdown-a11y-alert"
      role="alert"
      aria-live="assertive"
      style="position: absolute; width: 0; height: 0; clip: rect(0, 0, 0, 0)"
    ></div>
  </div>
</div>

<!-- Countdown clock - JavaScript -->

<script>
  class CountDownClock {
    constructor(
      containerDOMArg,
      selectedDateArg,
      timeZoneArg,
      placementArg,
      themeArg,
      urgencyIntervalArg,
      a11yAlertIntervalArg
    ) {
      this.countDownDOM = containerDOMArg; // Specific container for this instance
      this.countDownEl = containerDOMArg.querySelector(".tsw-countdown");

      if (!this.countDownEl) {
        console.error("Countdown element not found within this container:", containerEl);
        return;
      }

      this.countDownToThisTime = null;
      this.countDown = null;
      this.placement = placementArg || "card";
      this.timeZoneForTarget = timeZoneArg || "local";
      this.theme = themeArg || "light";
      this.urgencyInterval = urgencyIntervalArg !== undefined ? urgencyIntervalArg : 1;
      this.a11yAlertInterval = a11yAlertIntervalArg !== undefined ? a11yAlertIntervalArg : 10;
      this.selectedDate = selectedDateArg;

      this.init();
    }

    init() {
      if (!Number.isInteger(this.a11yAlertInterval)) {
        throw new Error("a11yAlertInterval is not a number");
      }

      this.setPlacement(this.placement);
      this.countDownToThisTime = this.setTimeZoneForTarget(this.selectedDate);
      this.setTheme(this.theme);
      this.countDown = this.startCountDown();
    }

    setPlacement(placement) {
      this.countDownEl.setAttribute("tsw-placement", placement);
    }

    setTimeZoneForTarget(date) {
      // Set time zone of input date/time using Luxon DateTime object
      if (this.timeZoneForTarget === "eastern" && typeof luxon !== "undefined") {
        const overrideZone = luxon.DateTime.fromISO(date, { zone: "America/New_York" });
        return overrideZone.toJSDate();
      } else {
        return new Date(date);
      }
    }

    setTheme(theme) {
      theme === "dark" ? this.countDownEl.classList.add("dark-theme") : this.countDownEl.classList.remove("dark-theme");
    }

    startCountDown() {
      return setInterval(() => {
        const secondsLeft = (this.countDownToThisTime - Date.now()) / 1000;
        if (secondsLeft < 0) {
          this.stopClock();
        }
        this.setView(secondsLeft);
      }, 1000);
    }

    setView(seconds) {
      // Use the instance's specific countDownEl to find children
      const displayDays = this.countDownEl.querySelector(".tsw-countdown-days");
      const displayHours = this.countDownEl.querySelector(".tsw-countdown-hours");
      const displayMinutes = this.countDownEl.querySelector(".tsw-countdown-minutes");
      const displaySeconds = this.countDownEl.querySelector(".tsw-countdown-seconds");
      const statusWrapper = this.countDownEl.querySelector(".tsw-countdown-status");
      const statusAlert = this.countDownEl.querySelector(".tsw-countdown-status-alert");
      const a11yAlert = this.countDownEl.querySelector("#tsw-countdown-a11y-alert");

      const secs = Math.floor(seconds % 60);
      const mins = Math.floor((seconds / 60) % 60);
      const hrs = Math.floor((seconds / (60 * 60)) % 24);
      const dys = Math.floor(seconds / (60 * 60 * 24));

      displaySeconds.textContent = secs > 0 ? (secs < 10 ? "0" + secs : secs) : "00";
      displayMinutes.textContent = mins > 0 ? (mins < 10 ? "0" + mins : mins) : "00";
      displayHours.textContent = hrs > 0 ? (hrs < 10 ? "0" + hrs : hrs) : "00";
      displayDays.textContent = dys > 0 ? (dys < 10 ? "0" + dys : dys) : "00";

      if (a11yAlert && dys < this.a11yAlertInterval) {
        a11yAlert.textContent = "Less than " + this.a11yAlertInterval + " days to go!";
      } else if (a11yAlert) {
        a11yAlert.textContent = "";
      }

      if (statusWrapper && dys < this.urgencyInterval) {
        statusWrapper.style.display = "block";
        const daysText = this.urgencyInterval === 1 ? "day" : "days";
        statusAlert.textContent = `Less than ${this.urgencyInterval} ${daysText} to go!`;
      } else if (statusWrapper) {
        statusWrapper.style.display = "none";
        statusAlert.textContent = "";
      }
    }

    stopClock() {
      clearInterval(this.countDown);
      this.countDownToThisTime = null;
      console.log("Clock stopped for container:", this.countDownDOM.id);
    }
  }

  // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
  // Start instance of clock on page load
  // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

  const countdownWrapper = document.querySelector("#tsw-countdown-id").querySelector("xpr-npi-content").shadowRoot;
  const clockInstanceDOM = countdownWrapper.querySelector("#container--1");
  let clockInstance = null;

  window.addEventListener("load", () => {
    // Generate default ISO string for 24 hours from now with Luxon DateTime object
    const today = luxon.DateTime.local();
    const tomorrow = today.plus({ days: 1 });
    const formattedResult = tomorrow.toFormat("yyyy-MM-dd'T'HH:mm");

    // Create instance of clock
    clockInstance = new CountDownClock(clockInstanceDOM, formattedResult, "local", "card", "light", 1, 30);
  });

  // =-=-=-=-=-=-=-=-=-=-
  // Modal focus trapping
  // =-=-=-=-=-=-=-=-=-=-

  const modal = clockInstanceDOM.querySelector(".tsw-modal");
  const modalFocusableElements = modal.querySelectorAll("button, input, select");

  const modalFirstElement = modalFocusableElements[0];
  const modalSecondElement = modalFocusableElements[1];
  const modalLastElement = modalFocusableElements[modalFocusableElements.length - 1];

  modal.addEventListener("keydown", (event) => {
    if (event.key === "Tab") {
      if (event.shiftKey) {
        if (countdownWrapper.activeElement === modalFirstElement) {
          modalLastElement.focus();
          event.preventDefault();
        }
      } else {
        if (countdownWrapper.activeElement === modalLastElement) {
          modalFirstElement.focus();
          event.preventDefault();
        }
      }
    }
  });

  // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
  // Modal and overlay event listeners
  // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

  const countdownEditButton = clockInstanceDOM.querySelector(".tsw-countdown-edit");
  const modalOverlay = clockInstanceDOM.querySelector(".tsw-modal-overlay");
  const modalClose = clockInstanceDOM.querySelector(".tsw-modal-close");
  const dateTimeInput = clockInstanceDOM.querySelector(".tsw-countdown-date");
  const dropdownPlacement = clockInstanceDOM.querySelector(".tsw-dropdown-placement");
  const dropdownTimeZone = clockInstanceDOM.querySelector(".tsw-dropdown-time-zone");
  const dropdownTheme = clockInstanceDOM.querySelector(".tsw-dropdown-theme");

  // Open modal
  countdownEditButton.addEventListener("click", () => {
    // Pre-populate modal fields and dropdowns with current clock state
    dateTimeInput.value = clockInstance.selectedDate;
    dropdownTheme.value = clockInstance.theme;
    dropdownTimeZone.value = clockInstance.timeZoneForTarget;
    // Open modal
    modalOverlay.classList.add("is-visible");
    // Add focus to first element in modal
    modalSecondElement.focus();
    console.log(modalFocusableElements);
  });

  // Close modal by clicking close button
  modalClose.addEventListener("click", () => {
    modalOverlay.classList.remove("is-visible");
  });

  // Close modal by clicking overlay
  modalOverlay.addEventListener("click", (event) => {
    if (event.target === modalOverlay) {
      modalOverlay.classList.remove("is-visible");
    }
  });

  // Close modal with Esc key
  countdownWrapper.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      modalOverlay.classList.remove("is-visible");
    }
  });

  // Change placement
  dropdownPlacement.addEventListener("change", (event) => {
    clockInstance.placement = event.target.value;
    clockInstance.setPlacement(event.target.value);
  });

  // Change target date
  dateTimeInput.addEventListener("change", (event) => {
    const newDateTime = event.target.value;

    if (!newDateTime) return;

    const selectedTime = clockInstance.setTimeZoneForTarget(newDateTime);
    if (selectedTime < Date.now()) {
      alert("Please select a future date and time");
      dateTimeInput.value = clockInstance.selectedDate;
      return;
    }

    clearInterval(clockInstance.countDown);
    clockInstance.selectedDate = newDateTime;
    clockInstance.countDownToThisTime = selectedTime;

    clockInstance.countDown = clockInstance.startCountDown();
  });

  // Change time zone
  dropdownTimeZone.addEventListener("change", (event) => {
    clockInstance.timeZoneForTarget = event.target.value;
    clearInterval(clockInstance.countDown);
    clockInstance.countDownToThisTime = clockInstance.setTimeZoneForTarget(clockInstance.selectedDate);
    clockInstance.startCountDown();
  });

  // Change theme
  dropdownTheme.addEventListener("change", (event) => {
    clockInstance.theme = event.target.value;
    clockInstance.setTheme(event.target.value);
  });
</script>
